<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Viewer</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .weather-card {
            transition: all 0.3s ease;
        }
        .weather-card.day {
            background-color: #f8f9fa;
            color: #212529;
        }
        .weather-card.night {
            background-color: #212529;
            color: #f8f9fa;
        }
        .location-card:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">Weather Viewer</a>
        <div class="navbar-nav ms-auto">
            <th:block th:if="${isAuthenticated}">
                <span class="navbar-text me-3" th:text="${userLogin}">User</span>
                <a class="btn btn-outline-light me-2" th:href="@{/settings}">Settings</a>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-light">Sign out</button>
                </form>
            </th:block>
            <th:block th:unless="${isAuthenticated}">
                <a class="btn btn-outline-light me-2" th:href="@{/sign-in}">Sign in</a>
                <a class="btn btn-outline-light" th:href="@{/sign-up}">Sign up</a>
            </th:block>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
    <!-- Search Form -->
    <form th:action="@{/}" method="get" class="row g-2 mb-4">
        <div class="col-auto">
            <input type="text" name="city" class="form-control" placeholder="Enter city name"
                   th:value="${param.city != null ? param.city[0] : ''}">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>

    <!-- Search Results -->
    <th:block th:if="${locations != null and not locations.empty}">
        <div class="row mb-4">
            <h4>Search Results</h4>
            <th:block th:each="location : ${locations}">
                <div class="col-md-3 mb-3">
                    <div class="card location-card">
                        <div class="card-body">
                            <!-- Город, страна и регион через запятую -->
                            <h5 class="card-title">
                                <span th:text="${location.city}"></span>
                                <span th:if="${location.country != null}">, <span th:text="${location.country}"></span></span>
                                <span th:if="${location.state != null}">, <span th:text="${location.state}"></span></span>
                            </h5>

                            <!-- Координаты через двоеточие -->
                            <p class="card-text text-muted mb-2">
                                <span th:text="${location.latitude} + ' : ' + ${location.longitude}"></span>
                            </p>

                            <!-- Локализованное имя согласно параметру lang -->
                            <p class="card-text" th:if="${location.localNames != null and location.localNames.containsKey(lang)}">
                                <span th:text="${location.localNames.get(lang)}"></span>
                            </p>

                            <!-- Кнопка добавления -->
                            <th:block th:if="${isAuthenticated}">
                                <form th:action="@{/add-location}" method="post" class="mt-3">
                                    <input type="hidden" name="city" th:value="${location.city}">
                                    <input type="hidden" name="country" th:value="${location.country}">
                                    <input type="hidden" name="state" th:value="${location.state}">
                                    <input type="hidden" name="latitude" th:value="${location.latitude}">
                                    <input type="hidden" name="longitude" th:value="${location.longitude}">
                                    <button type="submit" class="btn btn-primary btn-sm">Add to My Locations</button>
                                </form>
                            </th:block>
                            <th:block th:unless="${isAuthenticated}">
                                <p class="text-muted mt-3">Sign in to add this location</p>
                            </th:block>
                        </div>
                    </div>
                </div>
            </th:block>
        </div>
    </th:block>

    <!-- No Results Message -->
    <th:block th:if="${param.city != null and (locations == null or locations.empty)}">
        <div class="alert alert-info">No locations found for your search.</div>
    </th:block>

    <!-- User's Weather Locations -->
    <th:block th:if="${weatherData != null and not weatherData.empty}">
        <h4>Your Locations</h4>
        <div class="row">
            <th:block th:each="weather : ${weatherData}">
                <div class="col-md-6 mb-4">
                    <div class="card weather-card" th:classappend="${#strings.endsWith(weather.icon, 'd')} ? 'day' : 'night'">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title" th:text="${weather.city} + ', ' + ${weather.country}">City, Country</h5>
                                    <p class="card-text">
                                        <img th:src="@{/weather_icon/{icon}(icon=${weather.icon + '@2x.png'})}"
                                             alt="Weather icon" style="width: 50px; height: 50px;">
                                        <span th:text="${weather.temperature} + ${#locale.language == 'ru' ? '°C' : '°F'}">Temperature</span>
                                    </p>
                                    <p class="card-text" th:text="${weather.description}">Description</p>
                                </div>
                                <form th:action="@{/delete-location}" method="post">
                                    <input type="hidden" name="city" th:value="${weather.city}">
                                    <input type="hidden" name="country" th:value="${weather.country}">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </form>
                            </div>

                            <div class="mt-3">
                                <!-- Основные параметры погоды -->
                                <p class="card-text" th:if="${weather.feelsLike != null}"
                                   th:text="'Feels like: ' + ${weather.feelsLike} + ${#locale.language == 'ru' ? '°C' : '°F'}">Feels like</p>
                                <p class="card-text" th:if="${weather.minTemperature != null}"
                                   th:text="'Min: ' + ${weather.minTemperature} + ${#locale.language == 'ru' ? '°C' : '°F'}">Min temperature</p>
                                <p class="card-text" th:if="${weather.maxTemperature != null}"
                                   th:text="'Max: ' + ${weather.maxTemperature} + ${#locale.language == 'ru' ? '°C' : '°F'}">Max temperature</p>
                                <p class="card-text" th:if="${weather.humidity != null}"
                                   th:text="'Humidity: ' + ${weather.humidity} + '%'">Humidity</p>
                                <p class="card-text" th:if="${weather.pressure != null}"
                                   th:text="'Pressure: ' + ${weather.pressure} + ' hPa'">Pressure</p>

                                <!-- Ветер -->
                                <p class="card-text" th:if="${weather.speed != null}"
                                   th:text="'Wind speed: ' + ${weather.speed} + ${#locale.language == 'ru' ? ' m/s' : ' mph'}">Wind speed</p>
                                <p class="card-text" th:if="${weather.degree != null}"
                                   th:text="'Wind direction: ' + ${weather.degree} + '°'">Wind direction</p>

                                <!-- Облачность и осадки -->
                                <p class="card-text" th:if="${weather.cloudiness != null}"
                                   th:text="'Cloudiness: ' + ${weather.cloudiness} + '%'">Cloudiness</p>
                                <p class="card-text" th:if="${weather.rainMillimeters != null}"
                                   th:text="'Rain: ' + ${weather.rainMillimeters} + ' mm/h'">Rain</p>
                                <p class="card-text" th:if="${weather.snowMillimeters != null}"
                                   th:text="'Snow: ' + ${weather.snowMillimeters} + ' mm/h'">Snow</p>

                                <!-- Время восхода и заката -->
                                <p class="card-text" th:if="${weather.sunrise != null}">
                                    <span th:text="'Sunrise: ' + ${#temporals.format(#temporals.createDate(weather.sunrise * 1000), 'HH:mm')}"></span>
                                </p>
                                <p class="card-text" th:if="${weather.sunset != null}">
                                    <span th:text="'Sunset: ' + ${#temporals.format(#temporals.createDate(weather.sunset * 1000), 'HH:mm')}"></span>
                                </p>

                                <!-- Таймзона -->
                                <p class="card-text" th:if="${weather.timezone != null}"
                                   th:text="'Timezone: UTC' + (${weather.timezone} >= 0 ? '+' : '') + ${weather.timezone / 3600}">Timezone</p>
                            </div>
                        </div>
                    </div>
                </div>
            </th:block>
        </div>
    </th:block>

    <!-- Empty Locations Message -->
    <th:block th:if="${weatherData == null or weatherData.empty}">
        <div class="alert alert-info">No locations added yet. Search for a city to add it.</div>
    </th:block>
</div>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>